<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Worlds</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        iframe { width: 100%; height: 100vh; border: none; display: block; }
    </style>
</head>
<body>
    <iframe id="adaloFrame" allowfullscreen></iframe>
    <script>
        const baseAdaloURL = "https://previewer.adalo.com/9a617ecf-1f98-45a1-a2c1-657fc4b4922e?target=40eml51fa5ffqxxfgu5213u39&params=%7B%7D#";

        function getUserId() {
            const fragId = window.location.hash ? window.location.hash.replace(/^#/, '') : null;
            const params = new URLSearchParams(window.location.search);
            const queryId = params.get("userid");
            let tgId = null;
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                tgId = window.Telegram.WebApp.initDataUnsafe.user.id;
            }
            return fragId || queryId || tgId;
        }
        const userid = getUserId();

        function setFrameSrcWithUserId(userId) {
            const frame = document.getElementById("adaloFrame");
            frame.src = baseAdaloURL + (userId ? userId : "");
        }

        // Initially load the URL with "#" only (so the hash exists even if no id yet)
        setFrameSrcWithUserId("");

        // After 4 seconds, if userid is available, update the iframe src and refresh the page hash
        setTimeout(() => {
            if (userid) {
                setFrameSrcWithUserId(userid);

                // Optionally, refresh the website itself with the hash (so user's browser URL updates too)
                if (!window.location.hash.endsWith(userid)) {
                    window.location.hash = userid;
                    // If you want a full page reload (not recommended unless necessary):
                    // window.location.replace(window.location.pathname + window.location.search + "#" + userid);
                }
            }
        }, 4000);

        // Observe if the iframe src gets changed, and always ensure the correct hash is present in the iframe's src
        const frame = document.getElementById("adaloFrame");
        const observer = new MutationObserver(() => {
            setTimeout(() => {
                if (userid && !frame.src.endsWith("#" + userid)) {
                    setFrameSrcWithUserId(userid);
                }
            }, 4000);
        });
        observer.observe(frame, { attributes: true, attributeFilter: ['src'] });
    </script>
</body>
</html>
